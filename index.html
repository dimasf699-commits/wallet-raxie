<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hand Wave Hello</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Bebas+Neue&display=swap');

  :root {
    --bg: #0a0a0f;
    --accent: #00ffcc;
    --text: #e0e0e0;
    --card: #12121a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Space Mono', monospace;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2rem 1rem;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: 
      linear-gradient(rgba(0,255,204,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,204,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
  }

  .title {
    font-family: 'Bebas Neue', sans-serif;
    font-size: clamp(2.5rem, 8vw, 5rem);
    letter-spacing: 0.1em;
    color: var(--accent);
    text-shadow: 0 0 40px rgba(0,255,204,0.4);
    margin-bottom: 0.2em;
    text-align: center;
  }

  .subtitle {
    font-size: 0.75rem;
    letter-spacing: 0.3em;
    color: rgba(224,224,224,0.4);
    margin-bottom: 2.5rem;
    text-transform: uppercase;
    text-align: center;
  }

  .main-card {
    background: var(--card);
    border: 1px solid rgba(0,255,204,0.15);
    border-radius: 4px;
    padding: 2rem;
    width: min(90vw, 560px);
    position: relative;
  }

  .main-card::before, .main-card::after {
    content: '';
    position: absolute;
    width: 20px; height: 20px;
    border-color: var(--accent);
    border-style: solid;
  }
  .main-card::before { top: -1px; left: -1px; border-width: 2px 0 0 2px; }
  .main-card::after  { bottom: -1px; right: -1px; border-width: 0 2px 2px 0; }

  #video-wrapper {
    position: relative;
    width: 100%;
    aspect-ratio: 4/3;
    background: #000;
    border-radius: 2px;
    overflow: hidden;
    display: none;
    margin-bottom: 1.5rem;
  }

  #video-wrapper.active { display: block; }

  #video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    transform: scaleX(-1);
    display: block;
  }

  #canvas {
    position: absolute;
    top: 0; left: 0;
    width: 100%;
    height: 100%;
    transform: scaleX(-1);
  }

  .scan-line {
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    animation: scan 3s linear infinite;
    opacity: 0.6;
    pointer-events: none;
  }

  @keyframes scan { 0% { top: 0; } 100% { top: 100%; } }

  .gesture-overlay {
    position: absolute;
    bottom: 1rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    border: 1px solid var(--accent);
    padding: 0.4rem 1.2rem;
    font-size: 0.7rem;
    letter-spacing: 0.2em;
    color: var(--accent);
    text-transform: uppercase;
    white-space: nowrap;
  }

  #start-btn {
    display: block;
    width: 100%;
    padding: 1.1rem;
    background: transparent;
    border: 1px solid var(--accent);
    color: var(--accent);
    font-family: 'Space Mono', monospace;
    font-size: 0.85rem;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  #start-btn::before {
    content: '';
    position: absolute;
    inset: 0;
    background: var(--accent);
    transform: translateX(-101%);
    transition: transform 0.2s;
    z-index: 0;
  }
  #start-btn:hover::before { transform: translateX(0); }
  #start-btn:hover { color: var(--bg); }
  #start-btn span { position: relative; z-index: 1; }
  #start-btn.hidden { display: none; }

  .legend {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .legend-item {
    background: rgba(255,255,255,0.02);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 2px;
    padding: 0.75rem 0.5rem;
    text-align: center;
    transition: all 0.3s;
  }

  .legend-item.active-gesture {
    border-color: var(--accent);
    background: rgba(0,255,204,0.08);
    box-shadow: 0 0 20px rgba(0,255,204,0.15);
  }

  .legend-icon  { font-size: 1.8rem; margin-bottom: 0.3rem; display: block; }
  .legend-label { font-size: 0.6rem; letter-spacing: 0.2em; color: rgba(224,224,224,0.4); text-transform: uppercase; display: block; }
  .legend-word  { font-size: 0.75rem; color: var(--accent); display: block; margin-top: 0.2rem; font-weight: 700; }

  .status-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    color: rgba(224,224,224,0.3);
    text-transform: uppercase;
  }

  .status-dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: rgba(255,255,255,0.2);
    flex-shrink: 0;
    transition: all 0.3s;
  }
  .status-dot.online { background: var(--accent); box-shadow: 0 0 8px var(--accent); animation: blink 2s infinite; }
  .status-dot.error  { background: #ff3366; box-shadow: 0 0 8px #ff3366; }

  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .toast {
    position: fixed;
    top: 2rem;
    left: 50%;
    transform: translateX(-50%) translateY(-5rem);
    background: var(--accent);
    color: var(--bg);
    font-family: 'Bebas Neue', sans-serif;
    font-size: 2.5rem;
    letter-spacing: 0.15em;
    padding: 0.5rem 2.5rem;
    border-radius: 2px;
    transition: transform 0.35s cubic-bezier(0.34,1.56,0.64,1);
    z-index: 1000;
    pointer-events: none;
  }
  .toast.show { transform: translateX(-50%) translateY(0); }

  .loading-bar {
    width: 100%;
    height: 2px;
    background: rgba(0,255,204,0.1);
    margin-bottom: 1.5rem;
    display: none;
    position: relative;
    overflow: hidden;
  }
  .loading-bar.active { display: block; }
  .loading-bar::after {
    content: '';
    position: absolute;
    top: 0; left: -100%;
    width: 60%;
    height: 100%;
    background: var(--accent);
    animation: loading 1.2s linear infinite;
  }
  @keyframes loading { to { left: 140%; } }

  #error-box {
    display: none;
    background: rgba(255,51,102,0.1);
    border: 1px solid #ff3366;
    color: #ff7799;
    padding: 1rem;
    font-size: 0.72rem;
    line-height: 1.8;
    margin-bottom: 1rem;
    border-radius: 2px;
  }
  #error-box.active { display: block; }
</style>
</head>
<body>

<div class="toast" id="toast">HAI!</div>

<h1 class="title">HAND WAVE</h1>
<p class="subtitle">// gesture detector v2.0 //</p>

<div class="main-card">

  <div id="error-box"></div>
  <div class="loading-bar" id="loading-bar"></div>

  <button id="start-btn"><span>‚ñ∂ AKTIFKAN KAMERA</span></button>

  <div id="video-wrapper">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>
    <div class="scan-line"></div>
    <div class="gesture-overlay" id="gesture-label">ARAHKAN TANGAN KE KAMERA</div>
  </div>

  <div class="legend">
    <div class="legend-item" id="legend-1">
      <span class="legend-icon">‚òùÔ∏è</span>
      <span class="legend-label">1 jari</span>
      <span class="legend-word">"Halooo"</span>
    </div>
    <div class="legend-item" id="legend-2">
      <span class="legend-icon">‚úåÔ∏è</span>
      <span class="legend-label">2 jari</span>
      <span class="legend-word">"Halo Semua"</span>
    </div>
    <div class="legend-item" id="legend-5">
      <span class="legend-icon">üñêÔ∏è</span>
      <span class="legend-label">5 jari</span>
      <span class="legend-word">"Hai!"</span>
    </div>
  </div>

  <div class="status-bar">
    <div class="status-dot" id="status-dot"></div>
    <span id="status-text">KAMERA TIDAK AKTIF</span>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.10.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/handpose@0.0.7/dist/handpose.min.js"></script>

<script>
const video   = document.getElementById('video');
const canvas  = document.getElementById('canvas');
const ctx     = canvas.getContext('2d');
const btn     = document.getElementById('start-btn');
const wrapper = document.getElementById('video-wrapper');
const lbl     = document.getElementById('gesture-label');
const dot     = document.getElementById('status-dot');
const stxt    = document.getElementById('status-text');
const toast   = document.getElementById('toast');
const loadBar = document.getElementById('loading-bar');
const errBox  = document.getElementById('error-box');

let model = null;
let lastGesture = null;
let lastSpeakTime = 0;
const COOLDOWN = 2500;

function showError(msg) {
  errBox.innerHTML = msg;
  errBox.classList.add('active');
  dot.classList.remove('online');
  dot.classList.add('error');
  stxt.textContent = 'ERROR ‚Äî COBA LAGI';
}

function speak(text) {
  const now = Date.now();
  if (text === lastGesture && now - lastSpeakTime < COOLDOWN) return;
  lastGesture = text;
  lastSpeakTime = now;

  window.speechSynthesis && window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'id-ID';
  u.rate = 0.85;
  u.pitch = 1.1;
  window.speechSynthesis && window.speechSynthesis.speak(u);

  toast.textContent = text.toUpperCase();
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2000);
}

function highlight(n) {
  [1,2,5].forEach(x => document.getElementById('legend-'+x).classList.remove('active-gesture'));
  if ([1,2,5].includes(n)) document.getElementById('legend-'+n).classList.add('active-gesture');
}

function countFingers(lm) {
  let count = 0;
  // Thumb: horizontal distance
  if (Math.abs(lm[4][0] - lm[2][0]) > 30) count++;
  // 4 fingers: tip y < pip y means extended
  if (lm[8][1]  < lm[6][1])  count++;
  if (lm[12][1] < lm[10][1]) count++;
  if (lm[16][1] < lm[14][1]) count++;
  if (lm[20][1] < lm[18][1]) count++;
  return count;
}

const CONN = [
  [0,1],[1,2],[2,3],[3,4],
  [0,5],[5,6],[6,7],[7,8],
  [5,9],[9,10],[10,11],[11,12],
  [9,13],[13,14],[14,15],[15,16],
  [13,17],[17,18],[18,19],[19,20],[0,17]
];

function drawHand(lm) {
  const sx = canvas.width  / video.videoWidth;
  const sy = canvas.height / video.videoHeight;
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  ctx.strokeStyle = 'rgba(0,255,204,0.6)';
  ctx.lineWidth = 2;
  for (const [a,b] of CONN) {
    ctx.beginPath();
    ctx.moveTo(lm[a][0]*sx, lm[a][1]*sy);
    ctx.lineTo(lm[b][0]*sx, lm[b][1]*sy);
    ctx.stroke();
  }
  for (const [x,y] of lm) {
    ctx.beginPath();
    ctx.arc(x*sx, y*sy, 4, 0, Math.PI*2);
    ctx.fillStyle = '#00ffcc';
    ctx.fill();
  }
}

async function start() {
  errBox.classList.remove('active');
  btn.classList.add('hidden');
  loadBar.classList.add('active');
  stxt.textContent = 'MEMUAT MODEL AI...';

  try {
    model = await handpose.load();
    stxt.textContent = 'MENGAKSES KAMERA...';

    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });

    video.srcObject = stream;
    await new Promise(res => { video.onloadedmetadata = res; });
    await video.play();

    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;

    loadBar.classList.remove('active');
    wrapper.classList.add('active');
    dot.classList.add('online');
    stxt.textContent = 'MENDETEKSI TANGAN...';

    loop();
  } catch(err) {
    loadBar.classList.remove('active');
    btn.classList.remove('hidden');

    let msg = `<b>‚ö†Ô∏è ${err.name}:</b> ${err.message}<br><br>`;
    if (err.name === 'NotAllowedError') {
      msg += 'üìå <b>Solusi:</b> Klik ikon kamera/gembok di address bar, pilih <b>"Allow"</b>, lalu klik tombol lagi.';
    } else if (err.name === 'NotFoundError') {
      msg += 'üìå <b>Solusi:</b> Kamera tidak terdeteksi. Cek koneksi kamera atau coba browser lain.';
    } else if (location.protocol === 'file:') {
      msg += 'üìå <b>Masalah utama:</b> File dibuka langsung (file://). Browser memblokir kamera untuk file lokal.<br><br>';
      msg += '‚úÖ <b>Solusi paling mudah:</b><br>';
      msg += '1. Install <a href="https://marketplace.visualstudio.com/items?itemName=ritwickdey.LiveServer" style="color:var(--accent)">Live Server</a> di VS Code, klik kanan file ‚Üí Open with Live Server<br>';
      msg += '2. Atau buka terminal di folder file, jalankan: <code style="background:#1a1a2e;padding:2px 6px">python -m http.server 8000</code> lalu buka <code style="background:#1a1a2e;padding:2px 6px">localhost:8000</code>';
    } else {
      msg += 'üìå Pastikan buka via <b>HTTPS</b> dan browser Chrome/Edge terbaru.';
    }
    showError(msg);
  }
}

async function loop() {
  if (!model) return;
  try {
    const preds = await model.estimateHands(video);
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    if (preds.length > 0) {
      const lm = preds[0].landmarks;
      drawHand(lm);

      const n = countFingers(lm);
      highlight(n);

      if (n === 1)      { lbl.textContent = '‚òùÔ∏è  1 JARI ‚Äî HALOOO';       speak('Halooo'); }
      else if (n === 2) { lbl.textContent = '‚úåÔ∏è  2 JARI ‚Äî HALO SEMUANYA'; speak('Halo semuanya'); }
      else if (n === 5) { lbl.textContent = 'üñêÔ∏è  5 JARI ‚Äî HAI!';          speak('Hai'); }
      else {
        lbl.textContent = n === 0 ? 'KEPALAN TERDETEKSI' : `${n} JARI TERDETEKSI`;
        lastGesture = null;
      }
    } else {
      lbl.textContent = 'ARAHKAN TANGAN KE KAMERA';
      highlight(0);
      lastGesture = null;
    }
  } catch(e) { /* silent */ }

  requestAnimationFrame(loop);
}

btn.addEventListener('click', start);
</script>
</body>
</html>
